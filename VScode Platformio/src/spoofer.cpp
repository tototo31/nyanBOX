/* ____________________________
   This software is licensed under the MIT License:
   https://github.com/jbohack/nyanBOX
   ________________________________________ */
   
#include <Arduino.h> 
#include "../include/spoofer.h"
#include "../include/pindefs.h"

extern U8G2_SSD1306_128X64_NONAME_F_HW_I2C u8g2;
extern Adafruit_NeoPixel pixels;

#define DEVICE_NEXT_BTN   BUTTON_PIN_RIGHT
#define DEVICE_PREV_BTN   BUTTON_PIN_LEFT
#define ADV_CONTROL_BTN   BUTTON_PIN_UP

BLEAdvertising *pAdvertising;  
std::string devices_uuid = "00003082-0000-1000-9000-00805f9b34fb";

bool isAdvertising = false;
unsigned long lastDebounce = 0;
const unsigned long debounceDelay = 500;
const unsigned long packetDelay = 1000;

int deviceType = 1;
int deviceIndex = 0;
const int DEVICE_COUNT = 17;

// Payload data
const uint8_t DEVICES[][31] = {
  // Airpods
  {0x1e,0xff,0x4c,0x00,0x07,0x19,0x07,0x02,0x20,0x75,0xaa,0x30,0x01,0x00,0x00,0x45,0x12,0x12,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  // Airpods Pro
  {0x1e,0xff,0x4c,0x00,0x07,0x19,0x07,0x0e,0x20,0x75,0xaa,0x30,0x01,0x00,0x00,0x45,0x12,0x12,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  // Airpods Max
  {0x1e,0xff,0x4c,0x00,0x07,0x19,0x07,0x0a,0x20,0x75,0xaa,0x30,0x01,0x00,0x00,0x45,0x12,0x12,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  // Airpods Gen 2
  {0x1e,0xff,0x4c,0x00,0x07,0x19,0x07,0x0f,0x20,0x75,0xaa,0x30,0x01,0x00,0x00,0x45,0x12,0x12,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  // Airpods Gen 3
  {0x1e,0xff,0x4c,0x00,0x07,0x19,0x07,0x13,0x20,0x75,0xaa,0x30,0x01,0x00,0x00,0x45,0x12,0x12,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  // Airpods Pro Gen 2
  {0x1e,0xff,0x4c,0x00,0x07,0x19,0x07,0x14,0x20,0x75,0xaa,0x30,0x01,0x00,0x00,0x45,0x12,0x12,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  // Power Beats
  {0x1e,0xff,0x4c,0x00,0x07,0x19,0x07,0x03,0x20,0x75,0xaa,0x30,0x01,0x00,0x00,0x45,0x12,0x12,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  // Power Beats Pro
  {0x1e,0xff,0x4c,0x00,0x07,0x19,0x07,0x0b,0x20,0x75,0xaa,0x30,0x01,0x00,0x00,0x45,0x12,0x12,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  // Beats Solo Pro
  {0x1e,0xff,0x4c,0x00,0x07,0x19,0x07,0x0c,0x20,0x75,0xaa,0x30,0x01,0x00,0x00,0x45,0x12,0x12,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  // Beats Studio Buds
  {0x1e,0xff,0x4c,0x00,0x07,0x19,0x07,0x11,0x20,0x75,0xaa,0x30,0x01,0x00,0x00,0x45,0x12,0x12,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  // Beats Flex
  {0x1e,0xff,0x4c,0x00,0x07,0x19,0x07,0x10,0x20,0x75,0xaa,0x30,0x01,0x00,0x00,0x45,0x12,0x12,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  // Beats X
  {0x1e,0xff,0x4c,0x00,0x07,0x19,0x07,0x05,0x20,0x75,0xaa,0x30,0x01,0x00,0x00,0x45,0x12,0x12,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  // Beats Solo 3
  {0x1e,0xff,0x4c,0x00,0x07,0x19,0x07,0x06,0x20,0x75,0xaa,0x30,0x01,0x00,0x00,0x45,0x12,0x12,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  // Beats Studio 3
  {0x1e,0xff,0x4c,0x00,0x07,0x19,0x07,0x09,0x20,0x75,0xaa,0x30,0x01,0x00,0x00,0x45,0x12,0x12,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  // Beats Studio Pro
  {0x1e,0xff,0x4c,0x00,0x07,0x19,0x07,0x17,0x20,0x75,0xaa,0x30,0x01,0x00,0x00,0x45,0x12,0x12,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  // Betas Fit Pro
  {0x1e,0xff,0x4c,0x00,0x07,0x19,0x07,0x12,0x20,0x75,0xaa,0x30,0x01,0x00,0x00,0x45,0x12,0x12,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  // Beats Studio Buds Plus
  {0x1e,0xff,0x4c,0x00,0x07,0x19,0x07,0x16,0x20,0x75,0xaa,0x30,0x01,0x00,0x00,0x45,0x12,0x12,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
};

BLEAdvertisementData getAdvertismentData() {
  BLEAdvertisementData d;
  d.addData(std::string((char*)DEVICES[deviceIndex], 31));
  return d;
}

void updateDisplay() {
  u8g2.clearBuffer();
  u8g2.setFont(u8g2_font_profont11_tf);
  u8g2.drawStr(0,10,"Device:");
  switch (deviceType) {
    case 1:  u8g2.drawStr(0,25,"[ Airpods ]");            break;
    case 2:  u8g2.drawStr(0,25,"[ Airpods Pro ]");        break;
    case 3:  u8g2.drawStr(0,25,"[ Airpods Max ]");        break;
    case 4:  u8g2.drawStr(0,25,"[ Airpods Gen 2 ]");      break;
    case 5:  u8g2.drawStr(0,25,"[ Airpods Gen 3 ]");      break;
    case 6:  u8g2.drawStr(0,25,"[ Airpods Pro 2 ]");      break;
    case 7:  u8g2.drawStr(0,25,"[ Power Beats ]");        break;
    case 8:  u8g2.drawStr(0,25,"[ Power Beats Pro ]");    break;
    case 9:  u8g2.drawStr(0,25,"[ Beats Solo Pro ]");     break;
    case 10: u8g2.drawStr(0,25,"[ Beats Studio Buds ]");  break;
    case 11: u8g2.drawStr(0,25,"[ Beats Flex ]");         break;
    case 12: u8g2.drawStr(0,25,"[ Beats X ]");            break;
    case 13: u8g2.drawStr(0,25,"[ Beats Solo 3 ]");       break;
    case 14: u8g2.drawStr(0,25,"[ Beats Studio 3 ]");     break;
    case 15: u8g2.drawStr(0,25,"[ Beats Studio Pro ]");   break;
    case 16: u8g2.drawStr(0,25,"[ Beats Fit Pro ]");      break;
    case 17: u8g2.drawStr(0,25,"[ Studio Buds+ ]");       break;
    default: u8g2.drawStr(0,25,"[ Airpods ]");            break;
  }
  u8g2.drawStr(0,45,"Advertising:");
  u8g2.setCursor(80,45);
  u8g2.print(isAdvertising ? "Active" : "Disabled");
  u8g2.sendBuffer();
}

void changeDeviceNext() {
  if (++deviceType > DEVICE_COUNT) deviceType = 1;
  deviceIndex = deviceType - 1;
  updateDisplay();
}

void changeDevicePrev() {
  if (--deviceType < 1) deviceType = DEVICE_COUNT;
  deviceIndex = deviceType - 1;
  updateDisplay();
}

void toggleAdvertising() {
  unsigned long now = millis();
  if (now - lastDebounce < debounceDelay) return;
  lastDebounce = now;
  isAdvertising = !isAdvertising;
  if (!isAdvertising) {
    pAdvertising->stop();
  }
  updateDisplay();
}

void spooferSetup() {
  pinMode(DEVICE_NEXT_BTN, INPUT_PULLUP);
  pinMode(DEVICE_PREV_BTN, INPUT_PULLUP);
  pinMode(ADV_CONTROL_BTN, INPUT_PULLUP);

  BLEDevice::init("nyanBOX Spoofer");
  BLEServer *pServer = BLEDevice::createServer();
  pAdvertising = pServer->getAdvertising();
  pAdvertising->setAdvertisementType(ADV_TYPE_NONCONN_IND);
  updateDisplay();
}

void spooferLoop() {
  if (digitalRead(DEVICE_NEXT_BTN) == LOW) {
    delay(50);
    changeDeviceNext();
  }
  if (digitalRead(DEVICE_PREV_BTN) == LOW) {
    delay(50);
    changeDevicePrev();
  }
  if (digitalRead(ADV_CONTROL_BTN) == LOW) {
    delay(50);
    toggleAdvertising();
  }

  if (isAdvertising) {
    esp_bd_addr_t randAddr;
    for (int i = 0; i < 6; i++) randAddr[i] = random(256);
    randAddr[0] = (randAddr[0] & 0x3F) | 0xC0;
    pAdvertising->setDeviceAddress(randAddr, BLE_ADDR_TYPE_RANDOM);

    auto advData = getAdvertismentData();
    pAdvertising->setAdvertisementData(advData);
    pAdvertising->start();
    delay(packetDelay);
    pAdvertising->stop();
  }

  delay(50);
}